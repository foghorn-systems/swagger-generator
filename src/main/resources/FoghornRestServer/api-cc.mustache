
#include <foghorn/em/api/rest/generated/api/{{classname}}.h>
{{#imports}}
#include <foghorn/em/api/rest/generated/model/{{import}}.h>
{{/imports}}
#include <foghorn/em/api/rest/rest.h>
#include <foghorn/wire/rest.inl>

namespace foghorn {
namespace em {

namespace rest = foghorn::wire::rest;
using http_status_t = wire::rest::http_status_t;

// -----------------------------------------------

{{classname}}::{{classname}} (Controller* controller_):
  controller(controller_) {}

void {{classname}}::add_handlers (rest::Dispatcher& rest) {
  {{#operations}}
  {{#operation}}
  rest.addHandler("{{path}}", rest::{{httpMethod}}, this, &{{classname}}::{{operationId}});
  {{/operation}}
  {{/operations}}
}

{{#operations}}
{{#operation}}
// ----------------------------------------------
// {{operationId}}
// {{httpMethod}} "{{path}}"
//
// {{notes}}
// ----------------------------------------------
void {{classname}}::{{operationId}} (const Request& req, Response& res) {
   std::cout << "invoking {{operationId}}" << std::endl;

   {{#queryParams}}
   // {{paramName}}
   {{#isBoolean}}
   std::string {{paramName}}Str = req.get_param("{{paramName}}").empty() ?
      "{{defaultValue}}" : req.get_param("{{paramName}}");
   bool {{paramName}} = !{{paramName}}Str.compare("true");
   {{/isBoolean}}
   {{#isString}}
   std::string {{paramName}} = req.get_param("{{paramName}}").empty() ?
      "{{defaultValue}}" : req.get_param("{{paramName}}");
   {{/isString}}
   std::cout << "{{paramName}} query parameter [" << {{paramName}} << "] provided." << std::endl;

   {{/queryParams}}
   {{#pathParams}}
   // {{paramName}}
   std::string {{paramName}} = req.get_param("{{paramName}}");
   if ({{paramName}}.empty()) {
      std::cout << "Missing path param [ {{paramName}} ]\n";
      throw rest::Error("Missing path param [ {{paramName}} ]", http_status_t::bad_request);
   }
   std::cout << "{{paramName}} path parameter [" << {{paramName}} << "] provided." << std::endl;

   {{/pathParams}}
   {{#bodyParams}}
   // body param
   std::string body = req.get_body();
   std::cout << "{{operationId}} body: [" << body << "]" << std::endl;

   // Convert the body into Json.
   Json jsonBody;
   try {
      jsonBody = io::txt::from_string<Json>(body);
   } catch (std::exception& e) {
      std::cout << "Error reading request body [" << e.what() << "]" << std::endl;
      throw rest::Error(e.what(), http_status_t::bad_request);
   }

   // Create a {{dataType}} from Json
   {{dataType}} {{paramName}};
   {{paramName}}.fromJson(jsonBody);

   {{/bodyParams}}
   {{#responses}}
   {{#isDefault}}
   // Call into the controller
   {{#returnType}}{{{returnType}}} controllerRes = {{/returnType}}controller->{{operationId}}({{#allParams}}{{paramName}}{{#hasMore}}, {{/hasMore}}{{/allParams}});
   {{#returnType}}

   // Convert the {{{dataType}}} to json and return it
   // (expand is hard coded)
   {{^containerType}}
   Json responseJson = controllerRes->toJson(expand);
   {{/containerType}}
   {{#containerType}}
   Json::array_t arr;
   for (int i = 0; i < controllerRes.size(); ++i) {
      {{baseType}}* el = controllerRes.at(i);
      arr.push_back(el->toJson(expand));
   }
   Json responseJson { std::move(arr) };
   {{/containerType}}
   res.set_response(responseJson);
   {{/returnType}}
   {{^returnType}}
   res.set_response("");
   {{/returnType}}
   {{/isDefault}}
   {{/responses}}
}

{{/operation}}
{{/operations}}

}  // em
}  // foghorn

